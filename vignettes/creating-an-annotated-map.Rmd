---
title: "Creating an annotated map"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating an annotated map}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  echo=TRUE,
  message=FALSE,
  warning=FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

In this vignette, you will learn how to add new information to a map. Here, we retrieve a map for Berlin and get data for traffic accidents from _govdata.de_. 


```{r setup}
library(cartographr)
library(ggplot2)
library(vroom)
library(dplyr)
library(sf)
library(osmdata)
```

First, we load the locations of traffic accidents in Berlin for the year 2021. 


```{r load accident locations, echo=T, message=F}
df.accidents <- vroom("~/../Downloads/berlin_accidents.csv") |>
 st_as_sf(coords = c("XGCSWGS84", "YGCSWGS84"), crs=4326, remove = F) |>
 slice_head(n = 500) |> 
 mutate(type = as.factor(ifelse(IstRad == 1, "Bike involved", "No bike involved")))
  

df.accidents |> head()
```

# Setup the map parameters

We have to provide `longitude`, `latitude`. Furthermore, we define the extend of the OSM data in meters in `get_osmdata()`. 

```{r define coordinates}
osmdata::get_overpass_url()
osmdata::set_overpass_url("https://overpass.kumi.systems/api/interpreter")


df.berlin <- tibble(lat = c(52.516628),
       lon = c(13.378704),
       y_distance = c(2400),
       x_distance = c(2400*sqrt(2)),
       name = c("berlin"))

osm <- get_osmdata(df.berlin$lat, df.berlin$lon, df.berlin$y_distance,df.berlin$x_distance)
```

# Preprocess the osm data

The function `preprocess_map()` prepares the osm data for printing and removes unnecessary props on the map. 

```{r preprocessing}
osm_pps <- osm |> preprocess_map()
```

# Plot the map

`plot_map()` generates a `ggplot2` object using the color theme set as parameter. That means that we can easily adjust the plot using `ggplot2` commands and also add new information to the map. Note, that when adding a new `geom`, the coordinate system is reset, thus we need to reset the boundaries of the map using `adjust_display()`.


```{r plot map, fig.dim=c(16.5,11.7), fig.dpi = 72, out.width="100%"}
p <- osm_pps |> plot_map(theme = get_color("bwinv"),scaling = get_scaling("A3"))  +
  # add geom with coordinates of accidents
  geom_point(data = suppressMessages(sf::st_intersection(df.accidents,
                                                               osm_pps$my_bbox |> sf::st_as_sfc())),
             aes(x=XGCSWGS84,y=YGCSWGS84,color=type), size=5)+ # color="#FF474D")+
  
  # reset the boundary box after adding a new geom
  adjust_display(osm_pps) +
  
  # Set theme for labels
  theme(
    plot.title = element_text(size = 24,hjust = 0,face = "bold",colour = "#292e28"),
    plot.margin = margin(t = 5, r = 5, b = 5, l = 5, unit = "mm"),
    plot.caption = element_text(face="plain",size=10),
    legend.position = "top",
    legend.justification = c("right","top"),
    legend.margin = margin(-8, 0, 0, 0, unit = "mm")
  ) + 
  
  # Set labels
  labs(title = "Traffic accidents in Berlin (2021)",
       color = "Type",
       caption="Dataset: govdata.de\nÂ© Stadt Berlin (2024)")

p
```

# Save map

`save_map()` can be used to store the print-ready plot object to the disk as a drawn object in `pdf` format. Default mode for storing the output is `portrait` mode. Here, we want `landscape` orientation and can do so using the `orientation` parameter. 

```{r save map}
save_map(plot = p, filename=paste0("~/berlin_A3_bw.pdf"), orientation = "landscape")
```
